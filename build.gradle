buildscript {
	repositories {
		mavenCentral()
	}

	dependencies {
		classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion"
	}
}

plugins {
	id 'com.github.jk1.tcdeps' version '0.17' apply false
}

def rootProjectDir = projectDir

allprojects {
	apply plugin: 'kotlin'
	apply plugin: 'maven'
	apply plugin: 'com.github.jk1.tcdeps'

	sourceCompatibility = 1.8
	targetCompatibility = 1.8

	tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).all {
		kotlinOptions {
			jvmTarget = "1.8"
		}
	}

	repositories {
		mavenCentral()
		maven { url 'https://repo.gradle.org/gradle/libs-releases' }
		teamcityServer {
			url = teamCityUrl
			credentials {
				username = teamCityUsername
				password = teamCityPassword
			}
		}
	}

	configurations {
		kotlinJVMLib
	}

	dependencies {
		def kotlinTeamCity = "$kotlinBuildType:$kotlinBuild:kotlin-plugin-${kotlinPluginBuild}.zip!/Kotlin"

		implementation "com.google.guava:guava:21.0"
		implementation "org.gradle:gradle-tooling-api:4.3"
		implementation "org.eclipse.lsp4j:org.eclipse.lsp4j:0.5.0"

		implementation "org.jetbrains.kotlin:kotlin-compiler:$kotlinVersion"
		implementation "org.jetbrains.kotlin:kotlin-reflect:$kotlinVersion"
		kotlinJVMLib tc("$kotlinTeamCity/lib/kotlin-plugin.jar")
		kotlinJVMLib tc("$kotlinTeamCity/lib/j2k.jar")

		implementation fileTree(dir: "$rootProjectDir/lib", include: ["*.jar"])
		implementation fileTree(dir: "$rootProjectDir/lib-kotlin", include: ["*.jar"])
		testImplementation "org.hamcrest:hamcrest-all:1.3"
		testImplementation "junit:junit:4.10"
		testImplementation "org.openjdk.jmh:jmh-core:1.20"
		testImplementation "org.jetbrains.kotlin:kotlin-script-runtime:$kotlinVersion"
		annotationProcessor "org.openjdk.jmh:jmh-generator-annprocess:1.20"
	}

	configurations.all { config ->
		config.resolutionStrategy {
			preferProjectModules()
		}
	}

	task copyKotlinJVMLib(type: Copy) {
		from configurations.kotlinJVMLib
		into "$rootProjectDir/lib-kotlin"
	}

	compileKotlin.dependsOn copyKotlinJVMLib
}
